<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿ç“¦éš† - åœ¨çº¿ç‰ˆ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1419 100%);
            color: #e0e6ed;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(100, 149, 237, 0.1) 0%, transparent 70%);
            pointer-events: none;
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.1); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 3em;
            text-align: center;
            margin-bottom: 10px;
            color: #d4af37;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.5), 0 0 40px rgba(212, 175, 55, 0.3);
            letter-spacing: 4px;
        }

        .subtitle {
            text-align: center;
            color: #8a9fb0;
            margin-bottom: 40px;
            font-style: italic;
            font-size: 1.1em;
        }

        .card {
            background: rgba(15, 20, 35, 0.85);
            border: 2px solid rgba(100, 149, 237, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: rgba(100, 149, 237, 0.5);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6);
        }

        h2 {
            font-family: 'Cinzel', serif;
            color: #d4af37;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 2px solid rgba(212, 175, 55, 0.3);
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #b0c4d8;
            font-weight: 600;
        }

        input[type="text"], select {
            width: 100%;
            padding: 12px;
            background: rgba(20, 30, 50, 0.6);
            border: 2px solid rgba(100, 149, 237, 0.3);
            border-radius: 8px;
            color: #e0e6ed;
            font-size: 16px;
            font-family: 'Crimson Text', serif;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            color: #0a0e27;
            border: none;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(212, 175, 55, 0.5);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: linear-gradient(135deg, #555 0%, #444 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .player-card {
            background: rgba(30, 40, 60, 0.5);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid rgba(100, 149, 237, 0.2);
            text-align: center;
            transition: all 0.3s ease;
        }

        .player-card.online {
            border-color: rgba(76, 175, 80, 0.5);
            background: rgba(30, 60, 40, 0.3);
        }

        .player-card.offline {
            opacity: 0.5;
        }

        .player-card.selected {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }

        .role-good {
            color: #4dabf7;
        }

        .role-evil {
            color: #ff6b6b;
        }

        .status {
            padding: 8px 15px;
            background: rgba(100, 149, 237, 0.2);
            border-radius: 5px;
            display: inline-block;
            margin-top: 10px;
        }

        .mission-track {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            gap: 10px;
        }

        .mission-card {
            flex: 1;
            padding: 15px;
            background: rgba(30, 40, 60, 0.5);
            border: 2px solid rgba(100, 149, 237, 0.2);
            border-radius: 10px;
            text-align: center;
        }

        .mission-card.success {
            border-color: #4dabf7;
            background: rgba(77, 171, 247, 0.1);
        }

        .mission-card.fail {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        .log {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(10, 15, 25, 0.6);
            padding: 15px;
            border-radius: 8px;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid rgba(212, 175, 55, 0.3);
            padding-left: 10px;
        }

        .error {
            background: rgba(255, 107, 107, 0.2);
            border: 2px solid #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #ff6b6b;
        }

        .success {
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4caf50;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #4caf50;
        }

        .hidden {
            display: none;
        }

        .room-code {
            font-family: 'Courier New', monospace;
            font-size: 2em;
            color: #d4af37;
            text-align: center;
            padding: 20px;
            background: rgba(212, 175, 55, 0.1);
            border: 2px dashed #d4af37;
            border-radius: 10px;
            letter-spacing: 8px;
            margin: 20px 0;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            z-index: 1000;
        }

        .connection-status.connected {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4caf50;
            color: #4caf50;
        }

        .connection-status.disconnected {
            background: rgba(255, 107, 107, 0.3);
            border: 2px solid #ff6b6b;
            color: #ff6b6b;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }
            
            .player-list {
                grid-template-columns: 1fr;
            }
            
            .mission-track {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connectionStatus">
        ğŸ”´ æœªè¿æ¥
    </div>

    <div class="container">
        <h1>âš”ï¸ AVALON âš”ï¸</h1>
        <p class="subtitle">æ­£ä¹‰ä¸é‚ªæ¶çš„ç»ˆæå¯¹å†³</p>

        <!-- ç™»å½•ç•Œé¢ -->
        <div id="loginScreen" class="card">
            <h2>åŠ å…¥æ¸¸æˆ</h2>
            <div class="input-group">
                <label>ä½ çš„æ˜µç§°ï¼š</label>
                <input type="text" id="nicknameInput" placeholder="è¾“å…¥ä½ çš„æ˜µç§°" maxlength="20">
            </div>
            <div class="input-group">
                <label>æˆ¿é—´ä»£ç ï¼ˆç•™ç©ºåˆ›å»ºæ–°æˆ¿é—´ï¼‰ï¼š</label>
                <input type="text" id="roomCodeInput" placeholder="6ä½æˆ¿é—´ä»£ç " maxlength="6" style="text-transform: uppercase;">
            </div>
            <button onclick="joinRoom()">è¿›å…¥æˆ¿é—´</button>
            <div id="loginError" class="error hidden"></div>
        </div>

        <!-- å¤§å…ç•Œé¢ -->
        <div id="lobbyScreen" class="hidden">
            <div class="card">
                <h2>æ¸¸æˆå¤§å…</h2>
                <div class="room-code" id="displayRoomCode"></div>
                <p style="text-align: center; color: #8a9fb0;">åˆ†äº«æ­¤ä»£ç ç»™æœ‹å‹åŠ å…¥æ¸¸æˆ</p>
                
                <h3 style="color: #d4af37; margin-top: 30px;">ç©å®¶åˆ—è¡¨ (<span id="playerCount">0</span>)</h3>
                <div id="lobbyPlayers" class="player-list"></div>

                <div id="hostControls" class="hidden" style="margin-top: 30px;">
                    <div class="input-group">
                        <label>é€‰æ‹©æ¸¸æˆäººæ•°ï¼š</label>
                        <select id="playerNumSelect">
                            <option value="5">5äººå±€</option>
                            <option value="6">6äººå±€</option>
                            <option value="7">7äººå±€</option>
                            <option value="8">8äººå±€</option>
                            <option value="9">9äººå±€</option>
                            <option value="10">10äººå±€</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
                        <button onclick="deleteRoom()" style="background: linear-gradient(135deg, #ff6b6b 0%, #d63031 100%);">åˆ é™¤æˆ¿é—´</button>
                    </div>
                </div>

                <div id="waitingMessage" class="status" style="display: block; text-align: center; margin-top: 20px;">
                    ç­‰å¾…æˆ¿ä¸»å¼€å§‹æ¸¸æˆ...
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆç•Œé¢ -->
        <div id="gameScreen" class="hidden">
            <!-- èº«ä»½ä¿¡æ¯ -->
            <div class="card">
                <h2>ä½ çš„èº«ä»½</h2>
                <div id="roleInfo"></div>
                <button onclick="viewRole()" id="viewRoleBtn">æŸ¥çœ‹æˆ‘çš„èº«ä»½</button>
            </div>

            <!-- ä»»åŠ¡è¿›åº¦ -->
            <div class="card">
                <h2>ä»»åŠ¡è¿›åº¦</h2>
                <div id="missionTrack" class="mission-track"></div>
            </div>

            <!-- æ¸¸æˆæ“ä½œåŒº -->
            <div class="card">
                <h2>æ¸¸æˆçŠ¶æ€</h2>
                <div id="gameStatus"></div>
                <div id="gameActions"></div>
            </div>

            <!-- æ¸¸æˆæ—¥å¿— -->
            <div class="card">
                <h2>æ¸¸æˆæ—¥å¿—</h2>
                <div id="gameLog" class="log"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // è¿æ¥åˆ°æœåŠ¡å™¨
        const socket = io();
        
        let myNickname = '';
        let currentRoomCode = '';
        let isHost = false;
        let myRole = null;
        let currentRoom = null;

        const roleConfigs = {
            5: { good: 3, evil: 2, roles: ['æ¢…æ—', 'æ´¾è¥¿ç»´å°”', 'å¿ è‡£', 'è«ç”˜å¨œ', 'åˆºå®¢'] },
            6: { good: 4, evil: 2, roles: ['æ¢…æ—', 'æ´¾è¥¿ç»´å°”', 'å¿ è‡£', 'å¿ è‡£', 'è«ç”˜å¨œ', 'åˆºå®¢'] },
            7: { good: 4, evil: 3, roles: ['æ¢…æ—', 'æ´¾è¥¿ç»´å°”', 'å¿ è‡£', 'å¿ è‡£', 'è«ç”˜å¨œ', 'åˆºå®¢', 'è«å¾·é›·å¾·'] },
            8: { good: 5, evil: 3, roles: ['æ¢…æ—', 'æ´¾è¥¿ç»´å°”', 'å¿ è‡£', 'å¿ è‡£', 'å¿ è‡£', 'è«ç”˜å¨œ', 'åˆºå®¢', 'å¥¥ä¼¯ä¼¦'] },
            9: { good: 6, evil: 3, roles: ['æ¢…æ—', 'æ´¾è¥¿ç»´å°”', 'å¿ è‡£', 'å¿ è‡£', 'å¿ è‡£', 'å¿ è‡£', 'è«ç”˜å¨œ', 'åˆºå®¢', 'è«å¾·é›·å¾·'] },
            10: { good: 6, evil: 4, roles: ['æ¢…æ—', 'æ´¾è¥¿ç»´å°”', 'å¿ è‡£', 'å¿ è‡£', 'å¿ è‡£', 'å¿ è‡£', 'è«ç”˜å¨œ', 'åˆºå®¢', 'è«å¾·é›·å¾·', 'å¥¥ä¼¯ä¼¦'] }
        };

        const missionConfigs = {
            5: [2, 3, 2, 3, 3],
            6: [2, 3, 4, 3, 4],
            7: [2, 3, 3, 4, 4],
            8: [3, 4, 4, 5, 5],
            9: [3, 4, 4, 5, 5],
            10: [3, 4, 4, 5, 5]
        };

        // è¿æ¥çŠ¶æ€
        socket.on('connect', () => {
            updateConnectionStatus(true);
        });

        socket.on('disconnect', () => {
            updateConnectionStatus(false);
        });

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'connection-status connected';
                status.textContent = 'ğŸŸ¢ å·²è¿æ¥';
            } else {
                status.className = 'connection-status disconnected';
                status.textContent = 'ğŸ”´ æœªè¿æ¥';
            }
        }

        // åŠ å…¥æˆ¿é—´
        function joinRoom() {
            const nickname = document.getElementById('nicknameInput').value.trim();
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();

            if (!nickname) {
                showError('loginError', 'è¯·è¾“å…¥æ˜µç§°');
                return;
            }

            myNickname = nickname;

            if (!roomCode) {
                // åˆ›å»ºæ–°æˆ¿é—´
                socket.emit('createRoom', nickname, (response) => {
                    if (response.success) {
                        currentRoomCode = response.roomCode;
                        isHost = true;
                        enterLobby();
                    } else {
                        showError('loginError', response.error);
                    }
                });
            } else {
                // åŠ å…¥ç°æœ‰æˆ¿é—´
                socket.emit('joinRoom', { roomCode, nickname }, (response) => {
                    if (response.success) {
                        currentRoomCode = roomCode;
                        isHost = false;
                        enterLobby();
                    } else {
                        showError('loginError', response.error);
                    }
                });
            }
        }

        // è¿›å…¥å¤§å…
        function enterLobby() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('lobbyScreen').classList.remove('hidden');
            document.getElementById('displayRoomCode').textContent = currentRoomCode;

            if (isHost) {
                document.getElementById('hostControls').classList.remove('hidden');
                document.getElementById('waitingMessage').style.display = 'none';
            }
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            const playerNum = parseInt(document.getElementById('playerNumSelect').value);
            socket.emit('startGame', playerNum, (response) => {
                if (!response.success) {
                    alert(response.error);
                }
            });
        }

        // æŸ¥çœ‹èº«ä»½
        function viewRole() {
            socket.emit('viewRole');
        }

        // åˆ‡æ¢é˜Ÿä¼æˆå‘˜
        function toggleTeamMember(nickname) {
            socket.emit('toggleTeamMember', nickname);
        }

        // ç¡®è®¤é˜Ÿä¼
        function confirmTeam() {
            socket.emit('confirmTeam');
        }

        // æŠ•ç¥¨é˜Ÿä¼
        function voteTeam(approve) {
            socket.emit('voteTeam', approve);
        }

        // æŠ•ç¥¨ä»»åŠ¡
        function voteMission(success) {
            socket.emit('voteMission', success);
        }

        // åˆºæ€
        function assassinate(target) {
            socket.emit('assassinate', target);
        }

        // è¿”å›å¤§å…
        function returnToLobby() {
            socket.emit('returnToLobby');
        }

        // åˆ é™¤æˆ¿é—´
        function deleteRoom() {
            if (confirm('ç¡®å®šè¦åˆ é™¤æˆ¿é—´å—ï¼Ÿ')) {
                socket.emit('deleteRoom');
            }
        }

        // Socket äº‹ä»¶å¤„ç†
        socket.on('roomUpdate', (room) => {
            currentRoom = room;
            updateLobby(room);
        });

        socket.on('gameStart', (room) => {
            currentRoom = room;
            enterGame();
        });

        socket.on('gameUpdate', (room) => {
            currentRoom = room;
            updateGame(room);
        });

        socket.on('roleInfo', (data) => {
            myRole = data.role;
            displayRoleInfo(data);
        });

        socket.on('returnToLobby', (room) => {
            currentRoom = room;
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('lobbyScreen').classList.remove('hidden');
            myRole = null;
        });

        socket.on('roomDeleted', () => {
            alert('æˆ¿é—´å·²è¢«åˆ é™¤');
            location.reload();
        });

        // æ›´æ–°å¤§å…
        function updateLobby(room) {
            document.getElementById('playerCount').textContent = room.players.length;
            
            const playerList = document.getElementById('lobbyPlayers');
            playerList.innerHTML = room.players.map(p => `
                <div class="player-card ${p.online ? 'online' : 'offline'}">
                    <div style="font-size: 1.2em; font-weight: bold;">${p.nickname}</div>
                    ${p.nickname === room.host ? '<div style="color: #d4af37; margin-top: 5px;">ğŸ‘‘ æˆ¿ä¸»</div>' : ''}
                    ${!p.online ? '<div style="color: #ff6b6b; margin-top: 5px;">âš ï¸ ç¦»çº¿</div>' : ''}
                </div>
            `).join('');
        }

        // è¿›å…¥æ¸¸æˆ
        function enterGame() {
            document.getElementById('lobbyScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
        }

        // æ˜¾ç¤ºè§’è‰²ä¿¡æ¯
        function displayRoleInfo(data) {
            const isEvil = ['è«ç”˜å¨œ', 'åˆºå®¢', 'è«å¾·é›·å¾·', 'å¥¥ä¼¯ä¼¦', 'çˆªç‰™'].includes(myRole);
            const roleInfo = document.getElementById('roleInfo');
            
            let info = `<div style="font-size: 1.5em; margin-bottom: 20px;" class="${isEvil ? 'role-evil' : 'role-good'}">
                ä½ çš„èº«ä»½ï¼š<strong>${myRole}</strong>
            </div>`;

            info += `<div style="margin-bottom: 15px;">é˜µè¥ï¼š<strong class="${isEvil ? 'role-evil' : 'role-good'}">${isEvil ? 'é‚ªæ¶æ–¹' : 'æ­£ä¹‰æ–¹'}</strong></div>`;

            // æ˜¾ç¤ºç‰¹æ®Šè§†é‡
            if (myRole === 'æ¢…æ—') {
                const evilPlayers = data.players.filter(p => 
                    ['è«ç”˜å¨œ', 'åˆºå®¢', 'çˆªç‰™'].includes(p.role)
                ).map(p => p.nickname);
                info += `<div style="background: rgba(255,107,107,0.2); padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <strong>æ¢…æ—çš„è§†é‡ï¼š</strong><br>
                    ä½ çœ‹åˆ°çš„é‚ªæ¶æ–¹ï¼š${evilPlayers.join('ã€')}<br>
                    <em style="color: #ff6b6b;">âš ï¸ æ³¨æ„ï¼šä½ çœ‹ä¸åˆ°è«å¾·é›·å¾·ï¼</em>
                </div>`;
            } else if (myRole === 'æ´¾è¥¿ç»´å°”') {
                const merlinMorgana = data.players.filter(p => 
                    ['æ¢…æ—', 'è«ç”˜å¨œ'].includes(p.role)
                ).map(p => p.nickname);
                info += `<div style="background: rgba(77,171,247,0.2); padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <strong>æ´¾è¥¿ç»´å°”çš„è§†é‡ï¼š</strong><br>
                    æ¢…æ—å’Œè«ç”˜å¨œæ˜¯ï¼š${merlinMorgana.join('ã€')}<br>
                    <em>ä½ éœ€è¦é€šè¿‡æ¸¸æˆæ¨ç†å‡ºè°æ˜¯æ¢…æ—</em>
                </div>`;
            } else if (isEvil && myRole !== 'å¥¥ä¼¯ä¼¦') {
                const evilTeam = data.players.filter(p => 
                    ['è«ç”˜å¨œ', 'åˆºå®¢', 'è«å¾·é›·å¾·', 'çˆªç‰™'].includes(p.role) && p.nickname !== myNickname
                ).map(p => `${p.nickname}(${p.role})`);
                info += `<div style="background: rgba(255,107,107,0.2); padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <strong>é‚ªæ¶æ–¹åŒä¼´ï¼š</strong><br>
                    ${evilTeam.join('ã€')}
                </div>`;
            } else if (myRole === 'å¥¥ä¼¯ä¼¦') {
                info += `<div style="background: rgba(255,107,107,0.2); padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <strong>å¥¥ä¼¯ä¼¦ç‰¹æ€§ï¼š</strong><br>
                    ä½ ä¸çŸ¥é“å…¶ä»–é‚ªæ¶æ–¹æ˜¯è°ï¼Œå…¶ä»–é‚ªæ¶æ–¹ä¹Ÿä¸çŸ¥é“ä½ æ˜¯è°
                </div>`;
            }

            roleInfo.innerHTML = info;
            document.getElementById('viewRoleBtn').disabled = true;
        }

        // æ›´æ–°æ¸¸æˆçŠ¶æ€
        function updateGame(room) {
            updateMissionTrack(room);
            updateGameStatus(room);
            updateGameLog(room);
        }

        // æ›´æ–°ä»»åŠ¡è¿›åº¦
        function updateMissionTrack(room) {
            const playerNum = room.players.length;
            const track = document.getElementById('missionTrack');
            
            track.innerHTML = missionConfigs[playerNum].map((size, index) => {
                const mission = room.gameState.missions[index];
                let className = 'mission-card';
                let status = 'æœªè¿›è¡Œ';
                
                if (mission) {
                    className += mission.success ? ' success' : ' fail';
                    status = mission.success ? 'âœ“ æˆåŠŸ' : 'âœ— å¤±è´¥';
                }
                
                return `
                    <div class="${className}">
                        <div style="font-size: 1.2em; font-weight: bold;">ä»»åŠ¡ ${index + 1}</div>
                        <div style="margin: 10px 0;">éœ€è¦ ${size} äºº</div>
                        <div style="color: #d4af37;">${status}</div>
                        ${index === 3 && playerNum >= 7 ? '<div style="color: #ff6b6b; font-size: 0.9em; margin-top: 5px;">éœ€è¦2ä¸ªå¤±è´¥</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°æ¸¸æˆçŠ¶æ€
        function updateGameStatus(room) {
            const state = room.gameState;
            const statusDiv = document.getElementById('gameStatus');
            const actionsDiv = document.getElementById('gameActions');
            
            const currentLeaderNick = state.leaderOrder[state.currentLeader];
            const isLeader = currentLeaderNick === myNickname;
            const playerNum = room.players.length;
            const teamSize = missionConfigs[playerNum][state.currentRound - 1];

            let statusHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>å½“å‰å›åˆï¼š</strong>ç¬¬ ${state.currentRound} è½®ä»»åŠ¡<br>
                    <strong>å½“å‰é˜Ÿé•¿ï¼š</strong>${currentLeaderNick} ${isLeader ? '(ä½ )' : ''} ğŸ‘‘<br>
                    <strong>é˜Ÿä¼äººæ•°ï¼š</strong>${teamSize} äºº<br>
                    <strong>è¿ç»­æ‹’ç»ï¼š</strong>${state.teamRejections}/5
                </div>
            `;

            let actionsHTML = '';

            if (state.phase === 'team_building') {
                if (isLeader) {
                    actionsHTML = `
                        <h3 style="color: #d4af37; margin-bottom: 15px;">é€‰æ‹©é˜Ÿä¼æˆå‘˜ï¼ˆ${(state.team || []).length}/${teamSize}ï¼‰</h3>
                        <div class="player-list">
                            ${room.players.map(p => `
                                <div class="player-card ${(state.team || []).includes(p.nickname) ? 'selected' : ''}" 
                                     onclick="toggleTeamMember('${p.nickname}')" 
                                     style="cursor: pointer;">
                                    <div>${p.nickname}</div>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="confirmTeam()" ${(state.team || []).length !== teamSize ? 'disabled' : ''} 
                                style="margin-top: 20px; width: 100%;">ç¡®è®¤é˜Ÿä¼</button>
                    `;
                } else {
                    actionsHTML = `<div class="status">ç­‰å¾…é˜Ÿé•¿ ${currentLeaderNick} é€‰æ‹©é˜Ÿä¼...</div>`;
                }
            } else if (state.phase === 'team_voting') {
                statusHTML += `<div style="margin-top: 15px;"><strong>æè®®çš„é˜Ÿä¼ï¼š</strong>${state.team.join('ã€')}</div>`;
                
                if (!state.votes[myNickname]) {
                    actionsHTML = `
                        <h3 style="color: #d4af37; margin-bottom: 15px;">å¯¹è¿™ä¸ªé˜Ÿä¼æŠ•ç¥¨</h3>
                        <div class="button-group">
                            <button onclick="voteTeam(true)" style="background: linear-gradient(135deg, #4dabf7 0%, #3b8cc7 100%);">
                                âœ“ åŒæ„
                            </button>
                            <button onclick="voteTeam(false)" style="background: linear-gradient(135deg, #ff6b6b 0%, #d63031 100%);">
                                âœ— åå¯¹
                            </button>
                        </div>
                    `;
                } else {
                    actionsHTML = `<div class="status">ä½ å·²æŠ•ç¥¨ï¼Œç­‰å¾…å…¶ä»–ç©å®¶...</div>`;
                }
                
                const voteCount = Object.keys(state.votes).length;
                actionsHTML += `<div style="margin-top: 15px;">å·²æŠ•ç¥¨ï¼š${voteCount}/${playerNum}</div>`;
            } else if (state.phase === 'mission') {
                if (state.team.includes(myNickname)) {
                    if (!state.missionVotes[myNickname]) {
                        const isEvil = ['è«ç”˜å¨œ', 'åˆºå®¢', 'è«å¾·é›·å¾·', 'å¥¥ä¼¯ä¼¦', 'çˆªç‰™'].includes(myRole);
                        actionsHTML = `
                            <h3 style="color: #d4af37; margin-bottom: 15px;">æ‰§è¡Œä»»åŠ¡</h3>
                            <div class="button-group">
                                <button onclick="voteMission(true)" style="background: linear-gradient(135deg, #4dabf7 0%, #3b8cc7 100%);">
                                    âœ“ ä»»åŠ¡æˆåŠŸ
                                </button>
                                ${isEvil ? `
                                    <button onclick="voteMission(false)" style="background: linear-gradient(135deg, #ff6b6b 0%, #d63031 100%);">
                                        âœ— ä»»åŠ¡å¤±è´¥
                                    </button>
                                ` : ''}
                            </div>
                        `;
                    } else {
                        actionsHTML = `<div class="status">ä½ å·²æŠ•ç¥¨ï¼Œç­‰å¾…å…¶ä»–é˜Ÿå‘˜...</div>`;
                    }
                } else {
                    actionsHTML = `<div class="status">ç­‰å¾…é˜Ÿä¼æˆå‘˜æ‰§è¡Œä»»åŠ¡...</div>`;
                }
                
                const missionVoteCount = Object.keys(state.missionVotes).length;
                actionsHTML += `<div style="margin-top: 15px;">å·²æŠ•ç¥¨ï¼š${missionVoteCount}/${state.team.length}</div>`;
            } else if (state.phase === 'assassination') {
                const isAssassin = myRole === 'åˆºå®¢';
                if (isAssassin && !state.assassinTarget) {
                    const goodPlayers = room.players.filter(p => 
                        !['è«ç”˜å¨œ', 'åˆºå®¢', 'è«å¾·é›·å¾·', 'å¥¥ä¼¯ä¼¦', 'çˆªç‰™'].includes(p.role)
                    );
                    actionsHTML = `
                        <h3 style="color: #d4af37; margin-bottom: 15px;">ğŸ—¡ï¸ åˆºæ€æ¢…æ—</h3>
                        <p style="margin-bottom: 15px;">æ­£ä¹‰æ–¹å·²å®Œæˆ3æ¬¡ä»»åŠ¡ï¼ä½œä¸ºåˆºå®¢ï¼Œä½ æœ‰ä¸€æ¬¡æœºä¼šåˆºæ€æ¢…æ—ï¼Œå¦‚æœåˆºä¸­ï¼Œé‚ªæ¶æ–¹è·èƒœï¼</p>
                        <div class="player-list">
                            ${goodPlayers.map(p => `
                                <div class="player-card">
                                    <div>${p.nickname}</div>
                                    <button onclick="assassinate('${p.nickname}')" style="margin-top: 10px; background: linear-gradient(135deg, #ff6b6b 0%, #d63031 100%);">
                                        ğŸ—¡ï¸ åˆºæ€
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    actionsHTML = `<div class="status">ç­‰å¾…åˆºå®¢é€‰æ‹©ç›®æ ‡...</div>`;
                }
            } else if (state.phase === 'game_over') {
                actionsHTML = `
                    <div class="success" style="text-align: center; font-size: 1.2em;">
                        æ¸¸æˆç»“æŸï¼æŸ¥çœ‹æ—¥å¿—äº†è§£ç»“æœ
                    </div>
                    ${isHost ? `<button onclick="returnToLobby()" style="width: 100%; margin-top: 20px;">
                        è¿”å›å¤§å…
                    </button>` : ''}
                `;
            }

            statusDiv.innerHTML = statusHTML;
            actionsDiv.innerHTML = actionsHTML;
        }

        // æ›´æ–°æ¸¸æˆæ—¥å¿—
        function updateGameLog(room) {
            const logDiv = document.getElementById('gameLog');
            if (!room.gameState.log) return;
            
            logDiv.innerHTML = room.gameState.log.map(entry => 
                `<div class="log-entry">${entry}</div>`
            ).join('');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // å·¥å…·å‡½æ•°
        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }
    </script>
</body>
</html>
